{% load leaflet_tags %}
{% load geojson_tags %}

{% block extra_assets %}
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock %}

{% block content %}
    <html>
        <style>
            .leaflet-container {  /* all maps */
                width:  100%;
                height: 100%;
            }

            body {
                padding: 0;
                margin: 0;
            }
        </style>

        <body>
            <h1>Replay Vehicle Motion</h1>
        
            <script type="text/javascript">
                var waypoints = {{ waypoints|geojsonfeature:"start_location,last_location,vehicle_info,location_info"|safe }};

                var markers = [];
                
                
                function animate() {
                    for (i = 0; i < markers.length; i++) {
                        marker = markers[i]
                        marker.marker.setLatLng(L.latLng(
                            marker.track[marker.cnt][1],
                            marker.track[marker.cnt][0]));
                        var loc_info = marker.loc_info[marker.cnt];
                        var text = marker.popup_content + "<br>Time: " + loc_info[0] + "<br>Speed: " + Math.round(loc_info[1] * 3.6) + " km/h";
                        marker.popup.setContent(text);
                        if (++(marker.cnt) >= marker.len) {
                            marker.cnt = 0;
                        }
                    }
                }

                
                function main_map_init(map, options) {

                    // place makers
                    var features = waypoints.features;
                    for (i = 0; i < features.length; i++) {
                        var location = features[i].properties.start_location;
                        var track = features[i].geometry.coordinates
                        var loc_info = features[i].properties.location_info;
                        var veh_info = features[i].properties.vehicle_info;
                        var popup_content = "<p><img src=" + veh_info[1] + " height='50px'></p><p>" + "<b>" + veh_info[0] +"</b>";
                        if (location != null) {
                            var marker = L.marker(location);
                            //var popup = L.popup().setContent(features[i].properties.popup_content);
                            var popup = L.popup();
                            marker.bindPopup(popup);
                            marker.addTo(map);
                            markers.push({marker: marker, popup: popup, track: track, len: track.length, cnt: 0, loc_info: loc_info, popup_content: popup_content});
                        }
                    }
                    
                    // draw waypoints                    
                    var lineStyle = {
                        "color": "Red",
                        "weight": 5,
                        "opacity": 0.65
                    };
                    
                    var tracks = L.geoJson(waypoints, {
                        style: lineStyle
                    });

                    // set map viewport
                    var group = new L.featureGroup([tracks]);
                    map.fitBounds(group.getBounds());
                    tracks.addTo(map);
                    
                    // start animation
                    setInterval(animate, 200);

                }
            </script>
            
        </body>

        {% leaflet_map "main" callback="main_map_init" %}

    </html>
{% endblock %}
